name: Build FOSS
run-name: foss @ ${{ github.sha }}

concurrency:
  group: delta

on:
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v5

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        add-job-summary: never
  
    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        cache: gradle
        distribution: temurin
        java-version: 18

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        cache: pip
        python-version: '3.13'

    - name: Export vars
      run: |
        python -u resources/scripts/resolve_paths.py -p >> $GITHUB_ENV

    - name: Install Python deps
      run: |
        pip install -r ${{ env.sd }}/requirements.txt

    - name: Add icons
      run: |
        python -u ${{ env.sd }}/add_icons_wrapper.py

    - name: Set version
      run: |
        echo "filename=delta-${GITHUB_SHA::7}-foss" >> $GITHUB_ENV
        python -u ${{ env.sd }}/bump_version.py -w \
               -c "${GITHUB_SHA::7}|$(date +%s)"

    - name: Set icons count
      run: |
        python ${{ env.sd }}/count_icons.py -w

    - name: Create changelog
      run: |
        python ${{ env.sd }}/create_changelog.py \
          -p -w -r foss -x app/src/main/res/values/changelog.xml

    - name: Sort XMLs
      run: |
        cd ${{ env.sd }}
        python sort_appfilter.py -o
        python sort_drawable.py -o
        cp -fv ${{ env.a1 }} ${{ env.a2 }}
        cp -fv ${{ env.d1 }} ${{ env.a2 }}

    - name: Build APK
      run: |
        bash gradlew assembleFoss

    - name: Move unsigned APK
      run: |
        mv -v app/build/outputs/apk/foss/release/*.apk .

    - name: Sign APK
      uses: kevin-david/zipalign-sign-android-release@main
      id: sign_step
      with:
        alias: ${{ secrets.KEYSTORE_KEY_ALIAS }}
        keyPassword: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
        keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
        signingKeyBase64: ${{ secrets.KEYSTORE_BASE64 }}
        releaseDirectory: .

    - name: Rename signed APK
      run: |
        mv -v ${{ steps.sign_step.outputs.signedReleaseFile }} ${{ env.filename }}.apk

    - name: Upload signed APK to Artifacts
      uses: actions/upload-artifact@v5
      with:
        name: ${{ env.filename }}
        path: ${{ env.filename }}.apk
        retention-days: 7
